{% extends "base.html" %}

{% block title %}Automa√ß√£o Dia 8 - OXCASH{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5">
                <i class="fas fa-robot text-primary"></i> Automa√ß√£o Dia 8
            </h1>
            <p class="lead text-muted">Controle completo da automa√ß√£o para o dia 8</p>
        </div>
    </div>

    <!-- Controles -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-sliders-h"></i> Controles
                </div>
                <div class="card-body">
                    <div class="d-flex gap-3 align-items-center">
                        <button class="btn btn-success btn-lg" id="btn-start" onclick="startAutomation()">
                            <i class="fas fa-play"></i> Iniciar Automa√ß√£o
                        </button>
                        <button class="btn btn-danger btn-lg" id="btn-stop" onclick="stopAutomation()" disabled>
                            <i class="fas fa-stop"></i> Parar
                        </button>
                        <div class="ms-auto">
                            <div class="status-badge stopped" id="automation-status">
                                <i class="fas fa-circle"></i> Parado
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i> Progresso
                </div>
                <div class="card-body">
                    <div class="progress mb-2">
                        <div class="progress-bar bg-primary" id="progress-bar" style="width: 0%">0%</div>
                    </div>
                    <small class="text-muted" id="progress-text">Aguardando in√≠cio...</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Log -->
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-terminal"></i> Log de Execu√ß√£o</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                        <i class="fas fa-eraser"></i> Limpar
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="log-console" id="log-console">
                        <div class="log-line">
                            <span class="timestamp">[Sistema]</span>
                            <span class="info">‚ú® Interface carregada. Pronto para iniciar automa√ß√£o.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let socket;
const dia = 'dia8';

// Conecta ao WebSocket
function connectWebSocket() {
    socket = io();
    
    socket.on('connect', function() {
        addLog('Conectado ao servidor', 'success');
        
        // Verifica status atual da automa√ß√£o
        fetch(`/api/automation/status/${dia}`)
            .then(res => res.json())
            .then(data => {
                if (data.running) {
                    updateAutomationStatus(true);
                }
            })
            .catch(err => console.error('Erro ao verificar status:', err));
    });
    
    socket.on('log', function(data) {
        if (data.dia === dia || data.dia === 'general') {
            addLog(data.message, getLogType(data.message));
        }
    });
    
    socket.on('progress', function(data) {
        if (data.dia === dia) {
            updateProgress(data.value, data.message);
        }
    });
    
    socket.on('automation_status', function(data) {
        console.log('üì° Status recebido:', data);
        if (data.dia === dia) {
            updateAutomationStatus(data.running);
        }
    });
}

// For√ßa verifica√ß√£o de status ao conectar
socket.on('connect', function() {
    addLog('Conectado ao servidor', 'success');
    
    // Verifica status atual da automa√ß√£o
    fetch(`/api/automation/status/${dia}`)
        .then(res => res.json())
        .then(data => {
            if (data.running) {
                updateAutomationStatus(true);
            }
        })
        .catch(err => console.error('Erro ao verificar status:', err));
});

// Adiciona log
function addLog(message, type = 'info') {
    const console = document.getElementById('log-console');
    const timestamp = new Date().toLocaleTimeString();
    
    const logLine = document.createElement('div');
    logLine.className = 'log-line';
    logLine.innerHTML = `
        <span class="timestamp">[${timestamp}]</span>
        <span class="${type}">${message}</span>
    `;
    
    console.appendChild(logLine);
    console.scrollTop = console.scrollHeight;
}

// Determina tipo de log
function getLogType(message) {
    if (message.includes('‚úÖ') || message.includes('sucesso')) return 'success';
    if (message.includes('‚ùå') || message.includes('erro')) return 'error';
    if (message.includes('‚ö†Ô∏è') || message.includes('aten√ß√£o')) return 'warning';
    return 'info';
}

// Limpa log
function clearLog() {
    document.getElementById('log-console').innerHTML = '';
    addLog('Log limpo', 'info');
}

// Atualiza progresso
function updateProgress(value, message) {
    const bar = document.getElementById('progress-bar');
    const text = document.getElementById('progress-text');
    
    bar.style.width = value + '%';
    bar.textContent = value + '%';
    
    if (message) {
        text.textContent = message;
    }
}

// Atualiza status de automa√ß√£o
function updateAutomationStatus(running) {
    const badge = document.getElementById('automation-status');
    const btnStart = document.getElementById('btn-start');
    const btnStop = document.getElementById('btn-stop');
    
    if (running) {
        badge.className = 'status-badge running';
        badge.innerHTML = '<i class="fas fa-circle pulse"></i> Executando';
        btnStart.disabled = true;
        btnStop.disabled = false;
    } else {
        badge.className = 'status-badge stopped';
        badge.innerHTML = '<i class="fas fa-circle"></i> Parado';
        btnStart.disabled = false;
        btnStop.disabled = true;
    }
}

// Inicia automa√ß√£o
async function startAutomation() {
    try {
        addLog('üöÄ Iniciando automa√ß√£o...', 'info');
        
        // HABILITA BOT√ÉO PARAR IMEDIATAMENTE (n√£o espera resposta)
        updateAutomationStatus(true);
        
        const response = await fetch(`/api/automation/start/${dia}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            addLog('‚úÖ Automa√ß√£o iniciada com sucesso!', 'success');
        } else {
            addLog('‚ùå Erro: ' + data.error, 'error');
            updateAutomationStatus(false);  // Reverte se falhar
        }
    } catch (error) {
        addLog('‚ùå Erro ao iniciar: ' + error, 'error');
        updateAutomationStatus(false);  // Reverte se falhar
    }
}

// Para automa√ß√£o
async function stopAutomation() {
    try {
        addLog('‚èπÔ∏è Parando automa√ß√£o...', 'warning');
        
        // DESABILITA BOT√ÉO PARAR IMEDIATAMENTE (n√£o espera resposta)
        updateAutomationStatus(false);
        
        const response = await fetch(`/api/automation/stop/${dia}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            addLog('‚úÖ ' + data.message, 'success');
        } else {
            addLog('‚ùå Erro: ' + data.error, 'error');
        }
    } catch (error) {
        addLog('‚ùå Erro ao parar: ' + error, 'error');
    }
}

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
});
</script>
{% endblock %}
