{% extends "base_modern.html" %}

{% block title %}Automa√ß√£o Dia 8 - OXCASH{% endblock %}

{% block content %}
<style>
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        .d-flex.gap-3 {
            flex-direction: column;
            gap: 12px !important;
        }
        
        .d-flex.gap-3 .btn {
            width: 100%;
        }
        
        .d-flex.gap-3 .ms-auto {
            margin-left: 0 !important;
            margin-top: 10px;
        }
        
        .status-badge {
            width: 100%;
            text-align: center;
        }
        
        .log-container {
            max-height: 300px;
        }
        
        h1.display-5 {
            font-size: 1.5rem;
        }
        
        .lead {
            font-size: 1rem;
        }
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5">
                <i class="fas fa-robot text-primary"></i> Automa√ß√£o Dia 8
            </h1>
            <p class="lead text-muted">Controle completo da automa√ß√£o para o dia 8</p>
        </div>
    </div>

    <!-- Controles -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-sliders-h"></i> Controles
                </div>
                <div class="card-body">
                    <div class="d-flex gap-3 align-items-center">
                        <button class="btn btn-success btn-lg" id="btn-start" onclick="startAutomation()">
                            <i class="fas fa-play"></i> Iniciar Automa√ß√£o
                        </button>
                        <button class="btn btn-danger btn-lg" id="btn-stop" onclick="stopAutomation()" disabled>
                            <i class="fas fa-stop"></i> Parar
                        </button>
                        <div class="ms-auto">
                            <div class="status-badge stopped" id="automation-status">
                                <i class="fas fa-circle"></i> Parado
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i> Progresso
                </div>
                <div class="card-body">
                    <div class="progress mb-2">
                        <div class="progress-bar bg-primary" id="progress-bar" style="width: 0%">0%</div>
                    </div>
                    <small class="text-muted" id="progress-text">Aguardando in√≠cio...</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Log -->
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-terminal"></i> Log de Execu√ß√£o</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                        <i class="fas fa-eraser"></i> Limpar
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="log-console" id="log-console">
                        <div class="log-line">
                            <span class="timestamp">[Sistema]</span>
                            <span class="info">‚ú® Interface carregada. Pronto para iniciar automa√ß√£o.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Usa o socket global do base_modern.html
const dia = 'dia8';

// Conecta ao WebSocket
function connectWebSocket() {
    // Socket j√° est√° conectado globalmente no base_modern.html
    // Apenas adiciona os listeners espec√≠ficos desta p√°gina
    
    if (typeof socket === 'undefined') {
        console.error('‚ùå Socket global n√£o encontrado!');
        addLog('‚ùå Erro: WebSocket n√£o dispon√≠vel', 'error');
        return;
    }
    
    // Remove listeners antigos para evitar duplica√ß√£o
    socket.off('log');
    socket.off('progress');
    socket.off('automation_status');
    
    socket.on('connect', function() {
        console.log('üîå WebSocket conectado');
        addLog('‚úÖ Conectado ao servidor', 'success');
        
        // IMPORTANTE: Sempre verifica status real do servidor
        // Isso garante que ap√≥s trocar de aba, o bot√£o reflete o estado correto
        fetch(`/api/automation/status/${dia}`)
            .then(res => res.json())
            .then(data => {
                console.log('üìä Status atual do servidor:', data);
                updateAutomationStatus(data.running);
            })
            .catch(err => {
                console.error('‚ùå Erro ao verificar status:', err);
                // Em caso de erro, assume parado
                updateAutomationStatus(false);
            });
    });
    
    socket.on('log', function(data) {
        if (data.dia === dia || data.dia === 'general') {
            addLog(data.message, getLogType(data.message));
        }
    });
    
    socket.on('progress', function(data) {
        if (data.dia === dia) {
            updateProgress(data.value, data.message);
        }
    });
    
    socket.on('automation_status', function(data) {
        console.log('üì° Status recebido:', data);
        if (data.dia === dia) {
            // Se est√° tentando parar, n√£o atualiza status ainda
            // Deixa a fun√ß√£o stopAutomation() cuidar disso
            if (!window.isStopping) {
                updateAutomationStatus(data.running);
            } else if (data.running === false) {
                // Se recebeu confirma√ß√£o que parou, atualiza
                window.isStopping = false;
                updateAutomationStatus(false);
            }
        }
    });
}

// Adiciona log
function addLog(message, type = 'info') {
    const console = document.getElementById('log-console');
    const timestamp = new Date().toLocaleTimeString();
    
    const logLine = document.createElement('div');
    logLine.className = 'log-line';
    logLine.innerHTML = `
        <span class="timestamp">[${timestamp}]</span>
        <span class="${type}">${message}</span>
    `;
    
    console.appendChild(logLine);
    console.scrollTop = console.scrollHeight;
}

// Determina tipo de log
function getLogType(message) {
    if (message.includes('‚úÖ') || message.includes('sucesso')) return 'success';
    if (message.includes('‚ùå') || message.includes('erro')) return 'error';
    if (message.includes('‚ö†Ô∏è') || message.includes('aten√ß√£o')) return 'warning';
    return 'info';
}

// Limpa log
function clearLog() {
    document.getElementById('log-console').innerHTML = '';
    addLog('Log limpo', 'info');
}

// Atualiza progresso
function updateProgress(value, message) {
    const bar = document.getElementById('progress-bar');
    const text = document.getElementById('progress-text');
    
    bar.style.width = value + '%';
    bar.textContent = value + '%';
    
    if (message) {
        text.textContent = message;
    }
}

// Atualiza status de automa√ß√£o
function updateAutomationStatus(running) {
    const badge = document.getElementById('automation-status');
    const btnStart = document.getElementById('btn-start');
    const btnStop = document.getElementById('btn-stop');
    
    console.log('üîÑ updateAutomationStatus chamado:', {running, isStopping: window.isStopping});
    
    if (running) {
        badge.className = 'status-badge running';
        badge.innerHTML = '<i class="fas fa-circle pulse"></i> Executando';
        btnStart.disabled = true;
        btnStop.disabled = false;
        // Limpa flag de stopping se estava tentando parar
        window.isStopping = false;
    } else {
        badge.className = 'status-badge stopped';
        badge.innerHTML = '<i class="fas fa-circle"></i> Parado';
        btnStart.disabled = false;
        btnStop.disabled = true;
        // Limpa flag de stopping
        window.isStopping = false;
    }
}

// Inicia automa√ß√£o
async function startAutomation() {
    try {
        addLog('üöÄ Iniciando automa√ß√£o...', 'info');
        
        // HABILITA BOT√ÉO PARAR IMEDIATAMENTE (n√£o espera resposta)
        updateAutomationStatus(true);
        
        const response = await fetch(`/api/automation/start/${dia}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            addLog('‚úÖ Automa√ß√£o iniciada com sucesso!', 'success');
        } else {
            addLog('‚ùå Erro: ' + data.error, 'error');
            updateAutomationStatus(false);  // Reverte se falhar
        }
    } catch (error) {
        addLog('‚ùå Erro ao iniciar: ' + error, 'error');
        updateAutomationStatus(false);  // Reverte se falhar
    }
}

// Para automa√ß√£o
async function stopAutomation() {
    console.log('üõë stopAutomation iniciado');
    
    // Desabilita bot√£o imediatamente para evitar cliques duplos
    const btnStop = document.getElementById('btn-stop');
    const originalHTML = btnStop.innerHTML;
    btnStop.disabled = true;
    btnStop.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Parando...';
    
    try {
        window.isStopping = true;
        addLog('‚èπÔ∏è Enviando comando para parar...', 'warning');
        
        const response = await fetch(`/api/automation/stop/${dia}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üì• Resposta do servidor:', data);
        
        if (data.success) {
            addLog('‚úÖ ' + data.message, 'success');
            
            // For√ßa atualiza√ß√£o do status para parado
            updateAutomationStatus(false);
            
            // Limpa flag ap√≥s 1 segundo
            setTimeout(() => {
                window.isStopping = false;
            }, 1000);
        } else {
            addLog('‚ùå Erro: ' + data.error, 'error');
            window.isStopping = false;
            btnStop.disabled = false;
            btnStop.innerHTML = originalHTML;
        }
    } catch (error) {
        console.error('‚ùå Erro ao parar:', error);
        addLog('‚ùå Erro ao parar: ' + error.message, 'error');
        window.isStopping = false;
        btnStop.disabled = false;
        btnStop.innerHTML = originalHTML;
    }
}

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
});
</script>
{% endblock %}
