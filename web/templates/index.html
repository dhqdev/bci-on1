{% extends "base.html" %}

{% block title %}Dashboard - OXCASH{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-4">
                <i class="fas fa-chart-line"></i> Dashboard de Automa√ß√£o
            </h1>
            <p class="lead text-muted">Vis√£o geral do sistema OXCASH</p>
        </div>
        <div class="col-auto">
            <div class="status-badge success" id="connection-status">
                <i class="fas fa-circle pulse"></i> Conectado
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="dashboard-grid fade-in">
        <!-- Dia 8 - Total -->
        <div class="card stats-card">
            <div class="icon text-primary">
                <i class="fas fa-calendar-day"></i>
            </div>
            <div class="value text-primary" id="stats-dia8-total">0</div>
            <div class="label">Total Dia 8</div>
        </div>

        <!-- Dia 8 - Sucesso -->
        <div class="card stats-card">
            <div class="icon text-success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="value text-success" id="stats-dia8-success">0</div>
            <div class="label">Sucesso Dia 8</div>
        </div>

        <!-- Dia 16 - Total -->
        <div class="card stats-card">
            <div class="icon text-warning">
                <i class="fas fa-calendar-day"></i>
            </div>
            <div class="value text-warning" id="stats-dia16-total">0</div>
            <div class="label">Total Dia 16</div>
        </div>

        <!-- Dia 16 - Sucesso -->
        <div class="card stats-card">
            <div class="icon text-success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="value text-success" id="stats-dia16-success">0</div>
            <div class="label">Sucesso Dia 16</div>
        </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="row mb-4">
        <!-- Gr√°fico Dia 8 -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-pie"></i> Estat√≠sticas Dia 8
                </div>
                <div class="card-body">
                    <canvas id="chart-dia8" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√°fico Dia 16 -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-pie"></i> Estat√≠sticas Dia 16
                </div>
                <div class="card-body">
                    <canvas id="chart-dia16" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Atual + Visualizador de Automa√ß√£o -->
    <div class="row mb-4">
        <!-- Controles Laterais -->
        <div class="col-md-3">
            <!-- Automa√ß√£o Dia 8 -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="fas fa-robot"></i> Automa√ß√£o Dia 8
                </div>
                <div class="card-body">
                    <div class="status-badge stopped mb-3" id="status-dia8">
                        <i class="fas fa-circle"></i> Parado
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="startAutomationViewer('dia8')">
                            <i class="fas fa-play"></i> Iniciar
                        </button>
                        <button class="btn btn-danger" onclick="stopAutomationViewer('dia8')" disabled id="btn-stop-dia8">
                            <i class="fas fa-stop"></i> Parar
                        </button>
                    </div>
                    <div class="mt-2 text-center">
                        <small class="text-muted">ou</small>
                    </div>
                    <a href="/automation/dia8" class="btn btn-outline-primary btn-sm w-100">
                        <i class="fas fa-external-link-alt"></i> Abrir em aba separada
                    </a>
                </div>
            </div>

            <!-- Automa√ß√£o Dia 16 -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-robot"></i> Automa√ß√£o Dia 16
                </div>
                <div class="card-body">
                    <div class="status-badge stopped mb-3" id="status-dia16">
                        <i class="fas fa-circle"></i> Parado
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning" onclick="startAutomationViewer('dia16')">
                            <i class="fas fa-play"></i> Iniciar
                        </button>
                        <button class="btn btn-danger" onclick="stopAutomationViewer('dia16')" disabled id="btn-stop-dia16">
                            <i class="fas fa-stop"></i> Parar
                        </button>
                    </div>
                    <div class="mt-2 text-center">
                        <small class="text-muted">ou</small>
                    </div>
                    <a href="/automation/dia16" class="btn btn-outline-warning btn-sm w-100">
                        <i class="fas fa-external-link-alt"></i> Abrir em aba separada
                    </a>
                </div>
            </div>
        </div>

        <!-- Visualizador de Automa√ß√£o (Grande) -->
        <div class="col-md-9">
            <div class="card browser-viewer">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-desktop"></i> Visualizador de Automa√ß√£o
                        <span class="badge bg-secondary ms-2" id="viewer-dia">Nenhuma ativa</span>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light" onclick="refreshViewer()" title="Atualizar">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-outline-light" onclick="toggleFullscreen()" title="Tela cheia">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Screenshot do navegador -->
                    <div id="browser-screen" class="browser-screen">
                        <div class="browser-placeholder">
                            <i class="fas fa-browser fa-5x text-muted mb-3"></i>
                            <h5 class="text-muted">Nenhuma automa√ß√£o em execu√ß√£o</h5>
                            <p class="text-muted">Inicie uma automa√ß√£o para ver o navegador aqui</p>
                        </div>
                        <img id="browser-screenshot" class="browser-screenshot" style="display:none;" />
                    </div>
                    
                    <!-- Log Console Compacto -->
                    <div class="browser-log" id="viewer-log">
                        <div class="log-line">
                            <span class="timestamp">[Sistema]</span>
                            <span class="info">Aguardando in√≠cio da automa√ß√£o...</span>
                        </div>
                    </div>
                    
                    <!-- Barra de Progresso -->
                    <div class="browser-progress">
                        <div class="progress">
                            <div class="progress-bar bg-primary" id="viewer-progress" style="width: 0%">0%</div>
                        </div>
                        <div class="progress-text mt-1" id="viewer-progress-text">Pronto</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let socket;
let chartDia8, chartDia16;

// Conecta ao WebSocket
function connectWebSocket() {
    socket = io();
    
    socket.on('connect', function() {
        console.log('‚úÖ Conectado ao servidor');
        updateConnectionStatus(true);
    });
    
    socket.on('disconnect', function() {
        console.log('‚ùå Desconectado do servidor');
        updateConnectionStatus(false);
    });
    
    socket.on('automation_status', function(data) {
        updateAutomationStatus(data.dia, data.running);
    });
}

// Atualiza status de conex√£o
function updateConnectionStatus(connected) {
    const badge = document.getElementById('connection-status');
    if (connected) {
        badge.className = 'status-badge success';
        badge.innerHTML = '<i class="fas fa-circle pulse"></i> Conectado';
    } else {
        badge.className = 'status-badge stopped';
        badge.innerHTML = '<i class="fas fa-circle"></i> Desconectado';
    }
}

// Atualiza status de automa√ß√£o
function updateAutomationStatus(dia, running) {
    const statusEl = document.getElementById(`status-${dia}`);
    if (running) {
        statusEl.className = 'status-badge running';
        statusEl.innerHTML = '<i class="fas fa-circle pulse"></i> Executando';
    } else {
        statusEl.className = 'status-badge stopped';
        statusEl.innerHTML = '<i class="fas fa-circle"></i> Parado';
    }
}

// Carrega estat√≠sticas
async function loadStats() {
    try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        
        console.log('Estat√≠sticas carregadas:', data);
        
        // Atualiza cards
        document.getElementById('stats-dia8-total').textContent = data.dia8.total || 0;
        document.getElementById('stats-dia8-success').textContent = data.dia8.success || 0;
        document.getElementById('stats-dia16-total').textContent = data.dia16.total || 0;
        document.getElementById('stats-dia16-success').textContent = data.dia16.success || 0;
        
        // Atualiza status
        updateAutomationStatus('dia8', data.running.dia8);
        updateAutomationStatus('dia16', data.running.dia16);
        
        // Atualiza gr√°ficos
        updateCharts(data);
    } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
    }
}

// Cria gr√°ficos
function createCharts() {
    const ctxDia8 = document.getElementById('chart-dia8').getContext('2d');
    const ctxDia16 = document.getElementById('chart-dia16').getContext('2d');
    
    const chartConfig = (title) => ({
        type: 'doughnut',
        data: {
            labels: ['Sucesso', 'Falha', 'Parado'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: false
                }
            }
        }
    });
    
    chartDia8 = new Chart(ctxDia8, chartConfig('Dia 8'));
    chartDia16 = new Chart(ctxDia16, chartConfig('Dia 16'));
}

// Atualiza gr√°ficos
function updateCharts(data) {
    if (chartDia8) {
        chartDia8.data.datasets[0].data = [
            data.dia8.success,
            data.dia8.failed,
            data.dia8.stopped
        ];
        chartDia8.update();
    }
    
    if (chartDia16) {
        chartDia16.data.datasets[0].data = [
            data.dia16.success,
            data.dia16.failed,
            data.dia16.stopped
        ];
        chartDia16.update();
    }
}

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
    createCharts();
    loadStats();
    
    // Atualiza stats a cada 5 segundos
    setInterval(loadStats, 5000);
    
    // Atualiza screenshot do visualizador a cada 2 segundos (se ativo)
    setInterval(updateViewerScreenshot, 2000);
});

// ========== VISUALIZADOR DE AUTOMA√á√ÉO ==========

let currentViewerDia = null;
let screenshotInterval = null;

// Inicia automa√ß√£o no visualizador
async function startAutomationViewer(dia) {
    try {
        currentViewerDia = dia;
        document.getElementById('viewer-dia').textContent = `Dia ${dia === 'dia8' ? '8' : '16'} - Executando`;
        document.getElementById('viewer-dia').className = 'badge bg-success ms-2';
        
        addViewerLog(`üöÄ Iniciando automa√ß√£o ${dia === 'dia8' ? 'Dia 8' : 'Dia 16'}...`, 'info');
        
        // Habilita bot√£o parar
        document.getElementById(`btn-stop-${dia}`).disabled = false;
        
        // Inicia automa√ß√£o
        const response = await fetch(`/api/automation/start/${dia}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            addViewerLog('‚úÖ Automa√ß√£o iniciada com sucesso!', 'success');
            // Screenshot ir√° atualizar automaticamente via intervalo
        } else {
            addViewerLog('‚ùå Erro: ' + data.error, 'error');
            currentViewerDia = null;
        }
    } catch (error) {
        addViewerLog('‚ùå Erro ao iniciar: ' + error, 'error');
        currentViewerDia = null;
    }
}

// Para automa√ß√£o no visualizador
async function stopAutomationViewer(dia) {
    try {
        addViewerLog(`‚èπÔ∏è Parando automa√ß√£o ${dia === 'dia8' ? 'Dia 8' : 'Dia 16'}...`, 'warning');
        
        const response = await fetch(`/api/automation/stop/${dia}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            addViewerLog('‚úÖ ' + data.message, 'success');
            currentViewerDia = null;
            document.getElementById('viewer-dia').textContent = 'Nenhuma ativa';
            document.getElementById('viewer-dia').className = 'badge bg-secondary ms-2';
            document.getElementById(`btn-stop-${dia}`).disabled = true;
            
            // Limpa screenshot
            document.getElementById('browser-screenshot').style.display = 'none';
            document.querySelector('.browser-placeholder').style.display = 'flex';
        } else {
            addViewerLog('‚ùå Erro: ' + data.error, 'error');
        }
    } catch (error) {
        addViewerLog('‚ùå Erro ao parar: ' + error, 'error');
    }
}

// Atualiza screenshot do navegador
async function updateViewerScreenshot() {
    if (!currentViewerDia) return;
    
    try {
        const response = await fetch(`/api/automation/screenshot/${currentViewerDia}`);
        const data = await response.json();
        
        if (data.success && data.screenshot) {
            const img = document.getElementById('browser-screenshot');
            img.src = 'data:image/png;base64,' + data.screenshot;
            img.style.display = 'block';
            document.querySelector('.browser-placeholder').style.display = 'none';
        }
    } catch (error) {
        console.error('Erro ao carregar screenshot:', error);
    }
}

// Atualiza visualizador
function refreshViewer() {
    if (currentViewerDia) {
        addViewerLog('üîÑ Atualizando visualiza√ß√£o...', 'info');
        updateViewerScreenshot();
    }
}

// Tela cheia
function toggleFullscreen() {
    const viewer = document.querySelector('.browser-viewer');
    if (!document.fullscreenElement) {
        viewer.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

// Adiciona log no visualizador
function addViewerLog(message, type = 'info') {
    const console = document.getElementById('viewer-log');
    const timestamp = new Date().toLocaleTimeString();
    
    const logLine = document.createElement('div');
    logLine.className = 'log-line';
    logLine.innerHTML = `
        <span class="timestamp">[${timestamp}]</span>
        <span class="${type}">${message}</span>
    `;
    
    console.appendChild(logLine);
    console.scrollTop = console.scrollHeight;
    
    // Limita a 50 linhas
    while (console.children.length > 50) {
        console.removeChild(console.firstChild);
    }
}

// Escuta eventos WebSocket
socket.on('log', function(data) {
    if (currentViewerDia === data.dia || data.dia === 'general') {
        addViewerLog(data.message, getLogType(data.message));
    }
});

socket.on('progress', function(data) {
    if (currentViewerDia === data.dia) {
        const bar = document.getElementById('viewer-progress');
        const text = document.getElementById('viewer-progress-text');
        bar.style.width = data.value + '%';
        bar.textContent = data.value + '%';
        if (data.message) {
            text.textContent = data.message;
        }
    }
});

function getLogType(message) {
    if (message.includes('‚úÖ') || message.includes('sucesso')) return 'success';
    if (message.includes('‚ùå') || message.includes('erro')) return 'error';
    if (message.includes('‚ö†Ô∏è') || message.includes('aten√ß√£o')) return 'warning';
    return 'info';
}
</script>
{% endblock %}
