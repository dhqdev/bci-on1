{% extends "base.html" %}

{% block title %}Histórico - OXCASH{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-history"></i> Histórico de Lances</h1>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="refreshHistory()">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
            <button class="btn btn-danger" onclick="confirmClearHistory()">
                <i class="fas fa-trash"></i> Limpar Tudo
            </button>
        </div>
    </div>
    
    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dia8-tab">
                Dia 8 <span class="badge bg-primary ms-2" id="count-dia8">0</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dia16-tab">
                Dia 16 <span class="badge bg-warning ms-2" id="count-dia16">0</span>
            </button>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Dia 8 -->
        <div class="tab-pane fade show active" id="dia8-tab">
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-sm btn-outline-danger" onclick="clearSingleHistory('dia8')">
                    <i class="fas fa-trash-alt"></i> Limpar Dia 8
                </button>
            </div>
            <div class="history-table">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Grupo</th>
                            <th>Cota</th>
                            <th>Nome</th>
                            <th>Valor</th>
                            <th>Protocolo</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="history-dia8">
                        <tr><td colspan="7" class="text-center text-muted">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Dia 16 -->
        <div class="tab-pane fade" id="dia16-tab">
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-sm btn-outline-danger" onclick="clearSingleHistory('dia16')">
                    <i class="fas fa-trash-alt"></i> Limpar Dia 16
                </button>
            </div>
            <div class="history-table">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Grupo</th>
                            <th>Cota</th>
                            <th>Nome</th>
                            <th>Valor</th>
                            <th>Protocolo</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="history-dia16">
                        <tr><td colspan="7" class="text-center text-muted">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Conecta WebSocket para atualização em tempo real
const socket = io();

socket.on('history_update', function(data) {
    // Atualiza quando novo registro é adicionado
    console.log('Novo histórico recebido:', data);
    loadHistory(data.dia);
});

async function loadHistory(dia) {
    try {
        const response = await fetch(`/api/history/${dia}`);
        const result = await response.json();
        
        const tbody = document.getElementById(`history-${dia}`);
        const countBadge = document.getElementById(`count-${dia}`);
        tbody.innerHTML = '';
        
        if (result.success && result.data && result.data.length > 0) {
            // Atualiza contagem
            countBadge.textContent = result.data.length;
            
            // Mostra do mais recente para o mais antigo
            result.data.reverse().forEach(entry => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${entry.hora || '-'}</td>
                    <td>${entry.grupo || '-'}</td>
                    <td>${entry.cota || '-'}</td>
                    <td>${entry.nome || '-'}</td>
                    <td>${entry.valor_lance || '-'}</td>
                    <td>${entry.protocolo || '-'}</td>
                    <td>${entry.status || '-'}</td>
                `;
            });
        } else {
            countBadge.textContent = '0';
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Sem dados ainda. Execute uma automação para gerar histórico.</td></tr>';
        }
    } catch (error) {
        console.error('Erro ao carregar histórico:', error);
        const tbody = document.getElementById(`history-${dia}`);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-4">❌ Erro ao carregar dados: ' + error + '</td></tr>';
    }
}

function refreshHistory() {
    loadHistory('dia8');
    loadHistory('dia16');
}

async function confirmClearHistory() {
    if (confirm('⚠️ ATENÇÃO: Isso irá APAGAR TODO O HISTÓRICO de Dia 8 e Dia 16!\n\nTem certeza que deseja continuar?')) {
        try {
            const response = await fetch('/api/history/clear/all', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('✅ ' + data.message);
                refreshHistory();
            } else {
                alert('❌ Erro: ' + data.error);
            }
        } catch (error) {
            alert('❌ Erro ao limpar histórico: ' + error);
        }
    }
}

async function clearSingleHistory(dia) {
    if (confirm(`⚠️ Tem certeza que deseja apagar o histórico do ${dia.toUpperCase()}?`)) {
        try {
            const response = await fetch(`/api/history/clear/${dia}`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('✅ ' + data.message);
                loadHistory(dia);
            } else {
                alert('❌ Erro: ' + data.error);
            }
        } catch (error) {
            alert('❌ Erro ao limpar histórico: ' + error);
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadHistory('dia8');
    loadHistory('dia16');
    
    // Atualiza a cada 5 segundos
    setInterval(refreshHistory, 5000);
});
</script>
{% endblock %}
