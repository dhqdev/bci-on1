{% extends "base_modern.html" %}

{% block title %}WhatsApp - OXCASH{% endblock %}

{% block extra_css %}
<style>
    .whatsapp-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .whatsapp-group {
        background: var(--bg-primary);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
    }
    
    [data-theme="dark"] .whatsapp-group {
        background: var(--bg-secondary);
    }
    
    .whatsapp-group:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    [data-theme="dark"] .whatsapp-group:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }
    
    .whatsapp-group.dia8 {
        border-top: 4px solid #007bff;
    }
    
    .whatsapp-group.dia16 {
        border-top: 4px solid #ffc107;
    }
    
    .whatsapp-group-header {
        font-size: 1.2rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
        color: var(--text-primary);
    }
    
    /* Readonly field styling */
    #api-url {
        background: #f0f0f0 !important;
        color: #333 !important;
        cursor: not-allowed;
    }
    
    [data-theme="dark"] #api-url {
        background: #2a2a2a !important;
        color: #bbb !important;
    }
    
    /* Responsivo: empilha em mobile */
    @media (max-width: 768px) {
        .whatsapp-container {
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .container {
            padding-left: 12px;
            padding-right: 12px;
        }
        
        h1 {
            font-size: 1.5rem;
        }
        
        .card {
            margin-bottom: 16px;
        }
        
        .card-body {
            padding: 16px;
        }
        
        .whatsapp-group {
            padding: 16px;
        }
        
        .whatsapp-group-header {
            font-size: 16px;
            padding: 12px;
        }
        
        .form-control,
        .form-label {
            font-size: 14px;
        }
        
        textarea {
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 16px;
            font-size: 14px;
        }
    }
    
    @media (max-width: 480px) {
        h1 {
            font-size: 1.25rem;
        }
        
        .whatsapp-group {
            padding: 12px;
        }
        
        .card-body {
            padding: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4"><i class="fab fa-whatsapp text-success"></i> Disparo em Massa WhatsApp</h1>
    
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> Configure os contatos e mensagens para envio autom√°tico nos dias 8 e 16 de cada m√™s
    </div>
    
    <!-- Config API -->
    <div class="card mb-4">
        <div class="card-header">üîß Configura√ß√£o da Evolution API (URL Bloqueada)</div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label"><strong>URL da API:</strong></label>
                <input type="text" class="form-control" id="api-url" value="https://zap.tekvosoft.com" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label"><strong>Nome da Inst√¢ncia:</strong></label>
                <input type="text" class="form-control" id="api-instance">
            </div>
            <div class="mb-3">
                <label class="form-label"><strong>API Key:</strong></label>
                <input type="text" class="form-control" id="api-key">
            </div>
            <button class="btn btn-primary" onclick="saveConfig()">
                <i class="fas fa-save"></i> Salvar Configura√ß√£o
            </button>
        </div>
    </div>
    
    <!-- Grupos Dia 8 e 16 -->
    <div class="whatsapp-container">
        <!-- Dia 8 -->
        <div class="whatsapp-group dia8">
            <div class="whatsapp-group-header text-primary">
                üìÖ GRUPO DIA 8
            </div>
            <div class="mb-3">
                <label class="form-label"><strong>Contatos (um por linha):</strong></label>
                <small class="text-muted d-block">Formato: 5519995378302 - Nome Cliente</small>
                <textarea class="form-control" id="contacts-dia8" rows="6" placeholder="5519995378302 - Cliente Exemplo"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label"><strong>Mensagem do Dia 8:</strong></label>
                <small class="text-muted d-block">Use {nome} para personalizar</small>
                <textarea class="form-control" id="message-dia8" rows="4" placeholder="Ol√° {nome}! üéâ"></textarea>
            </div>
            <button class="btn btn-success w-100" onclick="sendMessages('dia8')">
                <i class="fas fa-paper-plane"></i> Enviar Agora
            </button>
        </div>
        
        <!-- Dia 16 -->
        <div class="whatsapp-group dia16">
            <div class="whatsapp-group-header text-warning">
                üìÖ GRUPO DIA 16
            </div>
            <div class="mb-3">
                <label class="form-label"><strong>Contatos (um por linha):</strong></label>
                <small class="text-muted d-block">Formato: 5519995378302 - Nome Cliente</small>
                <textarea class="form-control" id="contacts-dia16" rows="6" placeholder="5519995378302 - Cliente Exemplo"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label"><strong>Mensagem do Dia 16:</strong></label>
                <small class="text-muted d-block">Use {nome} para personalizar</small>
                <textarea class="form-control" id="message-dia16" rows="4" placeholder="Ol√° {nome}! üéâ"></textarea>
            </div>
            <button class="btn btn-success w-100" onclick="sendMessages('dia16')">
                <i class="fas fa-paper-plane"></i> Enviar Agora
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function saveConfig() {
    const data = {
        api: {
            base_url: document.getElementById('api-url').value,
            instance_name: document.getElementById('api-instance').value,
            api_key: document.getElementById('api-key').value
        }
    };
    
    try {
        const response = await fetch('/api/evolution-config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            alert('‚úÖ Configura√ß√£o salva com sucesso!');
        }
    } catch (error) {
        alert('‚ùå Erro: ' + error);
    }
}

async function sendMessages(dia) {
    const contactsId = `contacts-${dia}`;
    const messageId = `message-${dia}`;
    
    const contacts = document.getElementById(contactsId).value.trim();
    const message = document.getElementById(messageId).value.trim();
    
    if (!contacts) {
        alert('‚ùå Por favor, adicione contatos!');
        return;
    }
    
    if (!message) {
        alert('‚ùå Por favor, digite uma mensagem!');
        return;
    }
    
    // Mostra loading
    const btnText = event.target.innerHTML;
    event.target.disabled = true;
    event.target.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    
    try {
        const response = await fetch('/api/whatsapp/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                dia: dia,
                contacts: contacts,
                message: message
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ Sucesso!\n\n${result.message}\n\nEnviados: ${result.stats.success}\nFalhas: ${result.stats.failed}`);
            
            // Limpa campos se todos enviados
            if (result.stats.failed === 0) {
                if (confirm('Limpar campos?')) {
                    document.getElementById(contactsId).value = '';
                    document.getElementById(messageId).value = '';
                }
            }
        } else {
            alert('‚ùå Erro: ' + result.error);
        }
    } catch (error) {
        alert('‚ùå Erro ao enviar: ' + error);
    } finally {
        event.target.disabled = false;
        event.target.innerHTML = btnText;
    }
}

// Carrega config ao iniciar
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/api/evolution-config');
        const data = await response.json();
        
        if (data.success && data.data.api) {
            document.getElementById('api-instance').value = data.data.api.instance_name || '';
            document.getElementById('api-key').value = data.data.api.api_key || '';
        }
    } catch (error) {
        console.error('Erro ao carregar config:', error);
    }
});
</script>
{% endblock %}
