{% extends "base_modern.html" %}

{% block title %}Lances Servopa - OXCASH{% endblock %}

{% block content %}
<style>
    .page-header {
        margin-bottom: 32px;
    }
    
    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }
    
    .page-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }
    
    .import-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    [data-theme="dark"] .import-card {
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .import-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .btn-import {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-import:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-import:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-refresh {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-refresh:hover {
        background: var(--bg-tertiary);
        transform: translateY(-2px);
    }
    
    .status-text {
        color: var(--text-secondary);
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .status-text.loading {
        color: #667eea;
    }
    
    .status-text.success {
        color: #48bb78;
    }
    
    .status-text.error {
        color: #f56565;
    }
    
    .tabs-container {
        margin-bottom: 24px;
    }
    
    .nav-tabs {
        border-bottom: 2px solid var(--border-color);
    }
    
    .nav-tabs .nav-link {
        border: none;
        background: transparent;
        color: var(--text-secondary);
        padding: 12px 24px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .nav-tabs .nav-link:hover {
        color: var(--text-primary);
        background: var(--bg-secondary);
    }
    
    .nav-tabs .nav-link.active {
        color: #667eea;
        background: transparent;
    }
    
    .nav-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .tab-badge {
        background: rgba(102, 126, 234, 0.15);
        color: #667eea;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
        margin-left: 8px;
        font-weight: 600;
    }
    
    .nav-tabs .nav-link.active .tab-badge {
        background: rgba(102, 126, 234, 0.25);
    }
    
    /* KANBAN LAYOUT - Grid responsivo lado a lado */
    .kanban-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        padding-bottom: 24px;
    }
    
    .kanban-column {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        width: 100%;
    }
    
    [data-theme="dark"] .kanban-column {
        background: var(--bg-tertiary);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .kanban-column-header {
        margin-bottom: 0;
        padding: 16px;
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid var(--border-color);
    }
    
    .kanban-column-header:hover {
        background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);
        color: white;
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .kanban-column-header:hover .kanban-column-title,
    .kanban-column-header:hover .kanban-column-count,
    .kanban-column-header:hover .collapse-icon {
        color: white;
    }
    
    .kanban-column-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .collapse-icon {
        font-size: 1.2rem;
        color: var(--accent);
        transition: transform 0.3s ease;
    }
    
    .kanban-column-header.collapsed .collapse-icon {
        transform: rotate(-90deg);
    }
    
    .kanban-column-count {
        font-size: 0.9rem;
        color: var(--text-secondary);
        font-weight: 600;
    }
    
    .kanban-cards {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 16px;
        max-height: 2000px;
        overflow: hidden;
        transition: max-height 0.4s ease, opacity 0.3s ease, margin-top 0.3s ease;
        opacity: 1;
    }
    
    .kanban-cards.collapsed {
        max-height: 0;
        opacity: 0;
        margin-top: 0;
    }
    
    .lance-card {
        background: var(--bg-primary);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .lance-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        transform: translateY(-2px);
    }
    
    .lance-card.completed {
        border-color: #48bb78;
        background: rgba(72, 187, 120, 0.05);
    }
    
    [data-theme="dark"] .lance-card {
        background: var(--bg-secondary);
    }
    
    [data-theme="dark"] .lance-card.completed {
        background: rgba(72, 187, 120, 0.1);
    }
    
    .lance-card-header {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 8px;
    }
    
    .lance-checkbox {
        width: 20px;
        height: 20px;
        margin-top: 2px;
        cursor: pointer;
        accent-color: #667eea;
    }
    
    .lance-info {
        flex: 1;
    }
    
    .lance-cota {
        font-size: 1.1rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 4px;
    }
    
    .lance-nome {
        font-size: 0.95rem;
        color: var(--text-primary);
        margin-bottom: 8px;
    }
    
    .lance-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .lance-status.pendente {
        background: rgba(237, 137, 54, 0.1);
        color: #ed8936;
    }
    
    .lance-status.concluido {
        background: rgba(72, 187, 120, 0.1);
        color: #48bb78;
    }
    
    /* Campo de Busca - Sutil e Compacto */
    .search-container {
        background: transparent;
        border: none;
        padding: 0;
        margin-bottom: 16px;
    }
    
    .search-input-wrapper {
        position: relative;
        width: 100%;
        max-width: 350px;
    }
    
    .search-input-wrapper i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 0.85rem;
        opacity: 0.5;
    }
    
    .search-input {
        width: 100%;
        padding: 8px 12px 8px 35px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 0.875rem;
        transition: all 0.2s ease;
        opacity: 0.7;
    }
    
    .search-input:hover {
        opacity: 1;
        border-color: rgba(102, 126, 234, 0.3);
    }
    
    .search-input:focus {
        outline: none;
        opacity: 1;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }
    
    .search-input::placeholder {
        color: var(--text-secondary);
        opacity: 0.5;
        font-size: 0.85rem;
    }
    
    .search-stats {
        margin-top: 4px;
        font-size: 0.75rem;
        color: var(--text-secondary);
        opacity: 0.7;
        padding-left: 2px;
    }
    
    .kanban-card.hidden {
        display: none !important;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 16px;
        opacity: 0.3;
    }
    
    .empty-state p {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 8px;
    }
    
    .empty-state small {
        font-size: 0.9rem;
        opacity: 0.7;
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        .import-actions {
            flex-direction: column;
            align-items: stretch;
        }
        
        .btn-import, .btn-refresh {
            width: 100%;
            text-align: center;
        }
        
        .status-text {
            justify-content: center;
        }
        
        .kanban-container {
            grid-template-columns: 1fr;
        }
        
        .page-title {
            font-size: 1.5rem;
        }
        
        .nav-tabs .nav-link {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
    }
</style>

<div class="container-fluid">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-gavel"></i> Lances Servopa
        </h1>
        <p class="page-subtitle">Gestão completa de lances para os dias 8 e 16</p>
    </div>
    
    <div class="import-card" id="importCard" style="display: none;">
        <div class="import-actions">
            <button class="btn-import" id="btnImport" onclick="importLances()">
                <i class="fas fa-download"></i> Importar do Todoist pela Primeira Vez
            </button>
            <div class="status-text">
                <i class="fas fa-info-circle"></i>
                <span>Importe os dados do Todoist para começar</span>
            </div>
        </div>
    </div>
    
    <!-- Botões de Sincronização Manual -->
    <div class="import-card" id="syncCard" style="display: none;">
        <div class="import-actions">
            <button class="btn-import" id="btnSyncFrom" onclick="syncFromTodoist()">
                <i class="fas fa-cloud-download-alt"></i> Sincronizar do Todoist
            </button>
            <button class="btn-import" id="btnSyncTo" onclick="syncToTodoist()" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                <i class="fas fa-cloud-upload-alt"></i> Enviar para Todoist
            </button>
            <div class="status-text" id="statusMessage">
                <i class="fas fa-info-circle"></i>
                <span>Use os botões para sincronizar dados</span>
            </div>
        </div>
    </div>
    
    <!-- Campo de Busca -->
    <div class="search-container" id="searchContainer" style="display: none;">
        <div class="search-input-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" 
                   class="search-input" 
                   id="searchInput" 
                   placeholder="Buscar por número da cota ou título..."
                   onkeyup="filterLances()">
        </div>
        <div class="search-stats" id="searchStats"></div>
    </div>
    
    <div class="tabs-container">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dia08-tab" type="button">
                    <i class="fas fa-calendar-day"></i> Dia 08
                    <span class="tab-badge" id="badge08">0</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dia16-tab" type="button">
                    <i class="fas fa-calendar-alt"></i> Dia 16
                    <span class="tab-badge" id="badge16">0</span>
                </button>
            </li>
        </ul>
    </div>
    
    <div class="tab-content">
        <div class="tab-pane fade show active" id="dia08-tab">
            <div class="kanban-container" id="kanbanDia08">
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>Nenhum lance para o dia 08</p>
                    <small>Importe do Todoist para começar</small>
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="dia16-tab">
            <div class="kanban-container" id="kanbanDia16">
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>Nenhum lance para o dia 16</p>
                    <small>Importe do Todoist para começar</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let lancesData = null;
let syncInterval = null;
let hasData = false;

document.addEventListener('DOMContentLoaded', () => {
    console.log('🎯 Página de lances carregada');
    checkAndLoadData();
});

async function checkAndLoadData() {
    try {
        const response = await fetch('/api/lances');
        const result = await response.json();
        
        if (result.success && result.data) {
            const total08Cotas = result.data.dia08?.reduce((sum, g) => sum + (g.tasks?.length || 0), 0) || 0;
            const total16Cotas = result.data.dia16?.reduce((sum, g) => sum + (g.tasks?.length || 0), 0) || 0;
            
            if (total08Cotas > 0 || total16Cotas > 0) {
                // Tem dados - mostra interface COM BOTÕES MANUAIS
                hasData = true;
                lancesData = result.data;
                
                document.getElementById('importCard').style.display = 'none';
                document.getElementById('syncCard').style.display = 'block';
                document.getElementById('searchContainer').style.display = 'block';
                
                renderLances(lancesData);
                updateBadges(total08Cotas, total16Cotas);
                
                // SEM MAIS SYNC AUTOMÁTICO - usuário controla com botões
                console.log('✅ Dados carregados - Use os botões para sincronizar');
            } else {
                // Sem dados - mostra botão de importar
                hasData = false;
                document.getElementById('importCard').style.display = 'block';
                document.getElementById('syncCard').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                console.log('ℹ️ Nenhum dado encontrado - Clique em Importar');
            }
        } else {
            // Sem dados - mostra botão de importar
            hasData = false;
            document.getElementById('importCard').style.display = 'block';
            document.getElementById('syncCard').style.display = 'none';
            document.getElementById('searchContainer').style.display = 'none';
        }
    } catch (error) {
        console.error('Erro ao verificar dados:', error);
        document.getElementById('importCard').style.display = 'block';
        document.getElementById('syncCard').style.display = 'none';
        document.getElementById('searchContainer').style.display = 'none';
    }
}

// REMOVIDA A FUNÇÃO startAutoSync() - NÃO USAMOS MAIS SYNC AUTOMÁTICO

async function importLances() {
    const btn = document.getElementById('btnImport');
    const originalHTML = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando...';
    
    try {
        const response = await fetch('/api/lances/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            lancesData = result.data;
            hasData = true;
            
            // Esconde botão de importar, mostra status de sync e campo de busca
            document.getElementById('importCard').style.display = 'none';
            document.getElementById('syncCard').style.display = 'block';
            document.getElementById('searchContainer').style.display = 'block';
            
            renderLances(lancesData);
            
            const total08Cotas = result.data.dia08?.reduce((sum, g) => sum + (g.tasks?.length || 0), 0) || 0;
            const total16Cotas = result.data.dia16?.reduce((sum, g) => sum + (g.tasks?.length || 0), 0) || 0;
            
            updateBadges(total08Cotas, total16Cotas);
            
            // Inicia sincronização automática
            startAutoSync();
            
            // Notifica dashboard sobre mudanças
            if (typeof window.notifyDashboardUpdate === 'function') {
                window.notifyDashboardUpdate();
            }
            
            console.log('✅ Importação concluída - Sincronização automática iniciada');
        } else {
            alert('Erro ao importar: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao importar:', error);
        updateStatus('error', 'Erro ao importar: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

function renderLances(data) {
    const kanban08 = document.getElementById('kanbanDia08');
    const kanban16 = document.getElementById('kanbanDia16');
    
    // Renderiza Dia 08
    if (data.dia08 && data.dia08.length > 0) {
        kanban08.innerHTML = data.dia08.map(function(grupo) {
            return createKanbanColumn(grupo, '08');
        }).join('');
    } else {
        kanban08.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>Nenhum lance para o dia 08</p><small>Importe do Todoist para adicionar lances</small></div>';
    }
    
    // Renderiza Dia 16
    if (data.dia16 && data.dia16.length > 0) {
        kanban16.innerHTML = data.dia16.map(function(grupo) {
            return createKanbanColumn(grupo, '16');
        }).join('');
    } else {
        kanban16.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>Nenhum lance para o dia 16</p><small>Importe do Todoist para adicionar lances</small></div>';
    }
}

// ========== FUNÇÃO TOGGLE GRUPO (COLAPSAR/EXPANDIR) ==========
function toggleGrupo(grupoId) {
    const cardsContainer = document.getElementById(grupoId);
    const icon = document.getElementById('icon-' + grupoId);
    const header = icon.closest('.kanban-column-header');
    
    if (cardsContainer && icon) {
        const isCollapsed = cardsContainer.classList.contains('collapsed');
        
        if (isCollapsed) {
            // Expandir
            cardsContainer.classList.remove('collapsed');
            header.classList.remove('collapsed');
            icon.className = 'fas fa-folder-open collapse-icon';
        } else {
            // Colapsar
            cardsContainer.classList.add('collapsed');
            header.classList.add('collapsed');
            icon.className = 'fas fa-folder collapse-icon';
        }
    }
}

function createKanbanColumn(grupo, dia) {
    const tasks = grupo.tasks || [];
    const totalTasks = tasks.length;
    const completedTasks = tasks.filter(t => t.is_completed).length;
    const pendingTasks = totalTasks - completedTasks;
    
    const cardsHTML = tasks.map(function(task) {
        return createLanceCard(task, dia);
    }).join('');
    
    const grupoId = 'grupo-' + dia + '-' + (grupo.grupo || Math.random().toString(36).substr(2, 9));
    
    // Determina se grupo deve iniciar colapsado
    // Inicia colapsado se: pendingTasks === 0 (zerado) OU sempre (para começar limpo)
    const startCollapsed = true; // Sempre inicia colapsado
    const collapsedClass = startCollapsed ? 'collapsed' : '';
    const iconClass = startCollapsed ? 'fa-folder' : 'fa-folder-open';
    const headerCollapsedClass = startCollapsed ? 'collapsed' : '';
    
    return '<div class="kanban-column">' +
        '<div class="kanban-column-header ' + headerCollapsedClass + '" onclick="toggleGrupo(\'' + grupoId + '\')">' +
        '<div class="kanban-column-title">' +
        '<i class="fas ' + iconClass + ' collapse-icon" id="icon-' + grupoId + '"></i>' +
        (grupo.title || 'Grupo ' + grupo.grupo) +
        '</div>' +
        '<div class="kanban-column-count">' +
        '<i class="fas fa-tasks"></i> ' + completedTasks + '/' + totalTasks + ' concluídos' +
        (pendingTasks === 0 ? ' <span style="color: var(--success); font-weight: 700;">✓ Zerado</span>' : '') +
        '</div>' +
        '</div>' +
        '<div class="kanban-cards ' + collapsedClass + '" id="' + grupoId + '">' + cardsHTML + '</div>' +
        '</div>';
}

function createLanceCard(task, dia) {
    const isCompleted = task.is_completed || false;
    const statusClass = isCompleted ? 'concluido' : 'pendente';
    const statusText = isCompleted ? '<i class="fas fa-check-circle"></i> Concluído' : '<i class="fas fa-clock"></i> Pendente';
    const completedClass = isCompleted ? 'completed' : '';
    const taskId = task.task_id || '';
    const cotaNumber = task.cota || 'N/A';
    const cotaName = task.nome || 'Sem nome';
    
    return '<div class="kanban-card ' + completedClass + '" data-task-id="' + taskId + '" data-number="' + cotaNumber + '" data-title="' + cotaName + '">' +
        '<div class="lance-card-header">' +
        '<input type="checkbox" class="lance-checkbox" ' + (isCompleted ? 'checked' : '') + ' onchange="toggleStatus(\'' + taskId + '\', this.checked, \'' + dia + '\')">' +
        '<div class="lance-info">' +
        '<div class="lance-cota">📋 Cota ' + cotaNumber + '</div>' +
        '<div class="lance-nome">' + cotaName + '</div>' +
        '<span class="lance-status ' + statusClass + '">' + statusText + '</span>' +
        '</div></div></div>';
}

// ========== ATUALIZAÇÃO LOCAL (SEM API) ==========
// Checkboxes agora apenas marcam localmente
// Use o botão "Enviar para Todoist" para sincronizar

function toggleStatus(taskId, isCompleted, dia) {
    const card = document.querySelector('[data-task-id="' + taskId + '"]');
    
    // Atualiza dados locais imediatamente
    const diaKey = dia === '08' ? 'dia08' : 'dia16';
    if (lancesData && lancesData[diaKey]) {
        for (let grupo of lancesData[diaKey]) {
            if (grupo.tasks) {
                const task = grupo.tasks.find(t => t.task_id === taskId);
                if (task) {
                    task.is_completed = isCompleted;
                    
                    // Marca como pendente de envio
                    task.pending_sync = true;
                    break;
                }
            }
        }
    }
    
    // Atualiza visual imediatamente
    if (card) {
        if (isCompleted) {
            card.classList.add('completed');
            const statusEl = card.querySelector('.lance-status');
            if (statusEl) {
                statusEl.className = 'lance-status concluido';
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Concluído';
            }
        } else {
            card.classList.remove('completed');
            const statusEl = card.querySelector('.lance-status');
            if (statusEl) {
                statusEl.className = 'lance-status pendente';
                statusEl.innerHTML = '<i class="fas fa-clock"></i> Pendente';
            }
        }
    }
    
    // Salva no cache local
    saveLancesLocal();
    
    // Notifica que há mudanças pendentes
    updateSyncStatus();
    
    console.log('✅ Atualizado localmente - Clique em "Enviar para Todoist" para sincronizar');
}

// Salva dados localmente
function saveLancesLocal() {
    try {
        localStorage.setItem('lances_pending', JSON.stringify(lancesData));
    } catch (error) {
        console.warn('Erro ao salvar no localStorage:', error);
    }
}

// Atualiza mensagem de status
function updateSyncStatus() {
    const statusEl = document.getElementById('statusMessage');
    if (statusEl) {
        statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> <span>Há mudanças não sincronizadas - Clique em "Enviar para Todoist"</span>';
        statusEl.className = 'status-text';
        statusEl.style.color = '#ed8936';
    }
}

function updateBadges(count08, count16) {
                    }
                    
                    // Atualiza visualmente o card
                    if (card) {
                        if (isCompleted) {
                            card.classList.add('completed');
                            const statusEl = card.querySelector('.lance-status');
                            if (statusEl) {
                                statusEl.className = 'lance-status concluido';
                                statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Concluído';
                            }
                        } else {
                            card.classList.remove('completed');
                            const statusEl = card.querySelector('.lance-status');
                            if (statusEl) {
                                statusEl.className = 'lance-status pendente';
                                statusEl.innerHTML = '<i class="fas fa-clock"></i> Pendente';
                            }
                        }
                        card.style.opacity = '1';
                        card.style.pointerEvents = 'auto';
                    }
                    
                    if (checkbox) {
                        checkbox.disabled = false;
                    }
                    
                    // Notifica dashboard
function updateBadges(count08, count16) {
    document.getElementById('badge08').textContent = count08;
    document.getElementById('badge16').textContent = count16;
}

// ========== BUSCA E FILTRO ==========

function filterLances() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    const allCards = document.querySelectorAll('.kanban-card');
    
    let totalCards = 0;
    let visibleCards = 0;
    
    allCards.forEach(card => {
        totalCards++;
        const cardTitle = (card.getAttribute('data-title') || '').toLowerCase();
        const cardNumber = (card.getAttribute('data-number') || '').toLowerCase();
        
        // Busca por título ou número
        const matches = cardTitle.includes(searchTerm) || cardNumber.includes(searchTerm);
        
        if (matches || searchTerm === '') {
            card.classList.remove('hidden');
            visibleCards++;
        } else {
            card.classList.add('hidden');
        }
    });
    
    // Atualiza estatísticas da busca
    const statsEl = document.getElementById('searchStats');
    if (searchTerm === '') {
        statsEl.textContent = '';
    } else {
        statsEl.innerHTML = '<i class="fas fa-filter"></i> Mostrando ' + visibleCards + ' de ' + totalCards + ' lances';
    }
}

// ========== SINCRONIZAÇÃO MANUAL COM BOTÕES ==========

async function syncFromTodoist() {
    const btn = document.getElementById('btnSyncFrom');
    const statusEl = document.getElementById('statusMessage');
    const originalHTML = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';
    statusEl.innerHTML = '<i class="fas fa-sync fa-spin"></i> <span>Buscando dados do Todoist...</span>';
    statusEl.className = 'status-text loading';
    
    try {
        const response = await fetch('/api/lances/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
            throw new Error('Erro HTTP: ' + response.status);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // Atualiza dados locais
            lancesData = result.data;
            renderLances(lancesData);
            
            const total08Cotas = result.data.dia08?.reduce((sum, g) => sum + (g.tasks?.length || 0), 0) || 0;
            const total16Cotas = result.data.dia16?.reduce((sum, g) => sum + (g.tasks?.length || 0), 0) || 0;
            updateBadges(total08Cotas, total16Cotas);
            
            // Limpa pendências
            localStorage.removeItem('lances_pending');
            
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i> <span>Sincronizado com sucesso! (' + result.changes + ' mudanças)</span>';
            statusEl.className = 'status-text success';
            
            // Atualiza badge do menu
            if (typeof window.notifyDashboardUpdate === 'function') {
                window.notifyDashboardUpdate();
            }
            
            console.log('✅ Sincronizado do Todoist: ' + result.changes + ' mudanças');
        } else {
            throw new Error(result.error || 'Erro desconhecido');
        }
    } catch (error) {
        console.error('❌ Erro ao sincronizar do Todoist:', error);
        statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> <span>Erro: ' + error.message + '</span>';
        statusEl.className = 'status-text error';
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

async function syncToTodoist() {
    const btn = document.getElementById('btnSyncTo');
    const statusEl = document.getElementById('statusMessage');
    const originalHTML = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    statusEl.innerHTML = '<i class="fas fa-cloud-upload-alt fa-pulse"></i> <span>Enviando mudanças para o Todoist...</span>';
    statusEl.className = 'status-text loading';
    
    try {
        // Coleta todas as tasks com mudanças pendentes
        const pendingUpdates = [];
        
        ['dia08', 'dia16'].forEach(diaKey => {
            if (lancesData[diaKey]) {
                lancesData[diaKey].forEach(grupo => {
                    if (grupo.tasks) {
                        grupo.tasks.forEach(task => {
                            if (task.pending_sync) {
                                pendingUpdates.push({
                                    task_id: task.task_id,
                                    is_completed: task.is_completed
                                });
                            }
                        });
                    }
                });
            }
        });
        
        if (pendingUpdates.length === 0) {
            statusEl.innerHTML = '<i class="fas fa-info-circle"></i> <span>Nenhuma mudança para enviar</span>';
            statusEl.className = 'status-text';
            btn.disabled = false;
            btn.innerHTML = originalHTML;
            return;
        }
        
        // Envia em batch (com delay para evitar rate limit)
        let successCount = 0;
        let errorCount = 0;
        
        for (const update of pendingUpdates) {
            try {
                const response = await fetch('/api/lances/toggle/' + update.task_id, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_completed: update.is_completed })
                });
                
                if (response.ok) {
                    successCount++;
                    
                    // Remove flag de pendente
                    ['dia08', 'dia16'].forEach(diaKey => {
                        if (lancesData[diaKey]) {
                            lancesData[diaKey].forEach(grupo => {
                                if (grupo.tasks) {
                                    const task = grupo.tasks.find(t => t.task_id === update.task_id);
                                    if (task) {
                                        delete task.pending_sync;
                                    }
                                }
                            });
                        }
                    });
                } else {
                    errorCount++;
                }
                
                // Delay entre requisições para evitar rate limit
                await new Promise(resolve => setTimeout(resolve, 600));
                
            } catch (error) {
                console.error('Erro ao enviar task:', update.task_id, error);
                errorCount++;
            }
        }
        
        // Limpa pendências
        localStorage.removeItem('lances_pending');
        
        if (errorCount === 0) {
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i> <span>Enviado com sucesso! (' + successCount + ' mudanças)</span>';
            statusEl.className = 'status-text success';
        } else {
            statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>Parcialmente enviado: ' + successCount + ' OK, ' + errorCount + ' erros</span>';
            statusEl.className = 'status-text';
            statusEl.style.color = '#ed8936';
        }
        
        console.log('✅ Enviado para Todoist: ' + successCount + ' OK, ' + errorCount + ' erros');
        
    } catch (error) {
        console.error('❌ Erro ao enviar para Todoist:', error);
        statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> <span>Erro: ' + error.message + '</span>';
        statusEl.className = 'status-text error';
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

// Para compatibilidade com código antigo
async function syncFromTodoist_old(silent = true) {
    // Função antiga - não usada mais
    try {
        const response = await fetch('/api/lances/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
            console.warn('Erro HTTP na sincronização:', response.status);
            return;
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.warn('Resposta não é JSON');
            return;
        }
        
        const result = await response.json();
        
        if (result.success) {
            if (result.changes > 0) {
                console.log('🔄 Sincronizado: ' + result.changes + ' alterações do Todoist');
                
                // Atualiza a interface automaticamente
                lancesData = result.data;
                renderLances(lancesData);
                
                const total08Cotas = result.data.dia08?.reduce((sum, g) => sum + (g.tasks?.length || 0), 0) || 0;
                const total16Cotas = result.data.dia16?.reduce((sum, g) => sum + (g.tasks?.length || 0), 0) || 0;
                updateBadges(total08Cotas, total16Cotas);
                
                // Atualiza badge do menu
                if (typeof window.notifyDashboardUpdate === 'function') {
                    window.notifyDashboardUpdate();
                }
            }
        } else {
            console.warn('Erro na sincronização:', result.error);
        }
    } catch (error) {
        console.warn('Erro ao sincronizar:', error.message);
    }
}

// Para sincronização quando sair da página
window.addEventListener('beforeunload', () => {
    if (syncInterval) {
        clearInterval(syncInterval);
    }
});
</script>
{% endblock %}
